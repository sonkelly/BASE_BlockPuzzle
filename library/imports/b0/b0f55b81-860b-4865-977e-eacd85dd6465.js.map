{"version":3,"sources":["assets/Scripts/EffectCommon.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["const { ccclass, property } = cc._decorator;\n\n@ccclass\nexport default class EffectCommon extends cc.Component {\n    private parameters: {\n        time: number;\n        mouse: { x: number; y: number };\n        resolution: { x: number; y: number };\n        wavewidth: number;\n    } = null;\n\n    private _program: cc.GLProgram = null;\n    private _show_wave: boolean = false;\n    private _time: any = null;\n    private _mouse: any = null;\n\n    onLoad() {\n        this.parameters = {\n            time: 0,\n            mouse: {\n                x: 0.5,\n                y: 0.5\n            },\n            resolution: {\n                x: 0,\n                y: 0\n            },\n            wavewidth: 6 / 108\n        };\n\n        this.node.on(cc.Node.EventType.TOUCH_END, (event: cc.Event.EventTouch) => {\n            let touchPos = event.touch.getLocation();\n            touchPos = this.node.convertToNodeSpace(touchPos);\n            \n            this.parameters.mouse.x = touchPos.x / this.node.getContentSize().width;\n            this.parameters.mouse.y = touchPos.y / this.node.getContentSize().height;\n            this.parameters.time = 0;\n            this.parameters.wavewidth = 40 / this.node.getContentSize().width;\n            this.showWave();\n        }, this);\n\n        this._show_wave = false;\n        this._use();\n    }\n\n    showWave() {\n        this._show_wave = true;\n    }\n\n    update(dt: number) {\n        if (this._program && this._show_wave) {\n            this._program.use();\n            this.updateGLParameters(dt);\n\n            if (cc.sys.isNative) {\n                const glProgramState = cc.GLProgramState.getOrCreateWithGLProgram(this._program);\n                glProgramState.setUniformFloat(\"time\", this.parameters.time);\n                glProgramState.setUniformVec2(\"mouse\", this.parameters.mouse);\n            } else {\n                this._program.setUniformLocationWith1f(this._time, this.parameters.time);\n                this._program.setUniformLocationWith2f(this._mouse, this.parameters.mouse.x, 1 - this.parameters.mouse.y);\n            }\n        }\n    }\n\n    private updateGLParameters(dt: number) {\n        this.parameters.time += dt;\n    }\n\n    private _use() {\n        this._program = new cc.GLProgram();\n\n        if (cc.sys.isNative) {\n            cc.log(\"use native GLProgram\");\n            const vertShader = cc.shaderCache.getProgram(\"ccShader_Default_Vert_noMVP\");\n            const fragShader = cc.shaderCache.getProgram(\"ccShader_wave\");\n            this._program.initWithString(vertShader, fragShader);\n            \n            this._program.addAttribute(cc.macro.ATTRIBUTE_NAME_POSITION, cc.macro.VERTEX_ATTRIB_POSITION);\n            this._program.addAttribute(cc.macro.ATTRIBUTE_NAME_COLOR, cc.macro.VERTEX_ATTRIB_COLOR);\n            this._program.addAttribute(cc.macro.ATTRIBUTE_NAME_TEX_COORD, cc.macro.VERTEX_ATTRIB_TEX_COORDS);\n            \n            this._program.link();\n            this._program.updateUniforms();\n        } else {\n            const vertShader = cc.shaderCache.getProgram(\"ccShader_Default_Vert\");\n            const fragShader = cc.shaderCache.getProgram(\"ccShader_wave\");\n            this._program.initWithVertexShaderByteArray(vertShader, fragShader);\n            \n            this._program.addAttribute(cc.macro.ATTRIBUTE_NAME_POSITION, cc.macro.VERTEX_ATTRIB_POSITION);\n            this._program.addAttribute(cc.macro.ATTRIBUTE_NAME_COLOR, cc.macro.VERTEX_ATTRIB_COLOR);\n            this._program.addAttribute(cc.macro.ATTRIBUTE_NAME_TEX_COORD, cc.macro.VERTEX_ATTRIB_TEX_COORDS);\n            \n            this._program.link();\n            this._program.updateUniforms();\n        }\n\n        if (cc.sys.isNative) {\n            const glProgramState = cc.GLProgramState.getOrCreateWithGLProgram(this._program);\n            glProgramState.setUniformFloat(\"time\", this.parameters.time);\n            glProgramState.setUniformVec2(\"mouse\", this.parameters.mouse);\n        } else {\n            this._time = this._program.getUniformLocationForName(\"time\");\n            this._mouse = this._program.getUniformLocationForName(\"mouse\");\n            this._program.setUniformLocationWith1f(this._time, this.parameters.time);\n            this._program.setUniformLocationWith2f(this._mouse, this.parameters.mouse.x, this.parameters.mouse.y);\n        }\n\n        this.setProgram(this.node._sgNode, this._program);\n    }\n\n    private setProgram(node: any, program: cc.GLProgram) {\n        if (cc.sys.isNative) {\n            const glProgramState = cc.GLProgramState.getOrCreateWithGLProgram(program);\n            node.setGLProgramState(glProgramState);\n        } else {\n            node.setShaderProgram(program);\n        }\n\n        const children = node.children;\n        if (children) {\n            for (let i = 0; i < children.length; i++) {\n                this.setProgram(children[i], program);\n            }\n        }\n    }\n}"]}